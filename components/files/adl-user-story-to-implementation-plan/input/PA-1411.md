# [PA-1411] Consulta Items de Pago - Implementar la lógica de negocio y consumo de servicios

- **Proyecto:** [ADL PAGOS AVAL](https://avaldigitallabs.atlassian.net/secure/BrowseProject.jspa?id=11805)  
- **Principal:** [BPop - Parrilla de pagos (PA-1395)](https://avaldigitallabs.atlassian.net/browse/PA-1395)  
- **Estado:** Backlog  
- **Tipo:** Tech Story  
- **Prioridad:** Medium  
- **Informador:** [Oscar Daniel Arellano Montenegro](https://avaldigitallabs.atlassian.net/secure/ViewProfile.jspa?accountId=630534694c25135b97212621)  
- **Persona asignada:** [Gustavo Rodriguez](https://avaldigitallabs.atlassian.net/secure/ViewProfile.jspa?accountId=712020%3A770900c7-9e51-4369-9839-f48ae488bb50)  
- **Resolución:** Sin resolver  
- **Etiquetas:** Ninguno  
- **Votos:** 0  
- **Trabajo restante estimado:** Desconocido  
- **Tiempo trabajado:** Desconocido  
- **Estimación original:** Desconocido  
- **Automation Status:** Pending  

---

## Título
Consultar Items de Pago en `payment-item-client` y retornar arreglo formateado al Frontend

## Descripción
Este requerimiento técnico consiste en modificar la **lambda de consulta de ítems** para que acceda a la tabla **DynamoDB `payment-item-client`** y recupere todos los registros de pago asociados a un cliente.  

- La consulta se realizará utilizando la columna **clientDocument**, que se forma con la concatenación del tipo y número de documento del cliente.  
- Una vez recuperados los registros, la lambda debe procesar la columna **Card** y crear un arreglo que será entregado como respuesta al frontend.  
- Cada objeto en el arreglo debe incluir el **documentKey**, clave de la tabla que se usará en operaciones futuras.  
- Se debe crear la tabla con la estructura adjunta en la imagen.

---

## Criterios de Aceptación

### Creación de la Tabla DynamoDB
- Se ha creado la tabla `payment-item-client` con la estructura especificada.  
- La tabla incluye las columnas: **documentKey**, **clientDocument**, **data** y **card**.  

### Lógica de Consulta
- La lambda recibe tipo y número de documento del cliente.  
- Se concatenan estos valores para formar la clave de búsqueda en **clientDocument**.  
- Se realiza una consulta a la tabla `payment-item-client` para recuperar registros.  

### Procesamiento de Registros
- La lambda itera sobre los registros obtenidos.  
- Por cada registro se extrae la información de la columna **Card**.  
- Se construye un arreglo de objetos con **documentKey** y formato de **Card**.  

### Formato de la Respuesta
- El arreglo final se entrega como respuesta al frontend.  
- Cada objeto incluye el **documentKey** del registro.  

### Manejo de Errores y Excepciones
- La lambda maneja correctamente casos sin registros, retornando arreglo vacío o respuesta apropiada.  
- Se registran errores en **CloudWatch**.  

### Pruebas y Documentación
- Se crean pruebas unitarias e integración para validar la consulta, procesamiento y formato de respuesta.  
- Se actualiza la documentación de la lambda en **Confluence**.

---

## Detalles Técnicos
- **Componentes:** AWS Lambda, Amazon DynamoDB  
- **Base de Datos:** Tabla `payment-item-client`  
- **Clave de Búsqueda:** Concatenación de tipo y número de documento  
- **Estructura de la Tabla:**  
  - `documentKey` (clave de partición)  
  - `clientDocument` (índice de búsqueda)  
  - `data` (JSON)  
  - `card` (JSON)  
- **Lógica de Recorrido:** Iterar sobre resultados de DynamoDB para extraer y formatear información de `Card`.  

---

## Dependencias
- La tabla de DynamoDB `payment-item-client` debe existir con la estructura definida.  
- El rol IAM de la lambda debe tener permisos de consulta sobre la tabla.  
- La lambda debe tener acceso a la información de tipo y número de documento del cliente.  

---

## Ejemplo de Estructura JSON
```json
{
  "documentKey": "ASD9839",
  "type": "PublicService",
  "customTitle": "Custom Title",
  "agreementName": "Agreement Name or Company Name",
  "paymentReferences": [
    {
      "referenceNumber": "ref1",
      "value": "12345"
    }
  ],
  "paymentDate": "YYYY-MM-DD",
  "paymentStatus": "Pending",
  "isScheduled": true,
  "paymentAmount": 100.50,
  "totalDebtBalance": 5000.75,
  "installmentNumber": "2 of 100"
}
```

---

## Adjuntos
- Captura de pantalla 2025-09-08 a la(s) 9.46.11 p.m. (estructura de la tabla DynamoDB)  

---

**Generado automáticamente desde Jira por Oscar Daniel Arellano Montenegro el 09/sep/25**  

---


### Table Structure
| Field | Type | Description |
|-------|------|-------------|
| `documentKey` | String (S) | Hash key - Client document identifier |
| `clientDocument` | String (S) | Client information |
| `data` | String (S) | Complete service response (JSON format) |
| `card` | String (S) | Summarized card information (JSON format) |

---
